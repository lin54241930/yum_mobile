> 这里主要是分享我平时需要用到的一些场景，STF怎么连接的设备

## 一、stf服务运行在连接设备的服务器上

- 这个是最为常见的一种场景，通常我们只需要用数据线将设备连接到服务器上
- 一般作为服务器的机器USB插口并不多，这个时候我们就需要用到Usb Hub 这中东西某宝某东上有很多，搜一搜就有
- 再者就是系统限制，部分Linux系统可能插上手机后，并不能识别手机，有可能是adb权限问题，还有可能是本身设备原因，这时候我们需要一一排除问题，如果有手机能连接上，而有的手机不能，则可能是手机没有开启开发者调试或者是没有开启安全调试（MIUI系统需要开启），还有部分手机需要将STFServer这个加入到省电白名单
- 还有一种系统限制则是连接部分手机后，再插手机就只能充电，而不能被识别，这种情况很可能是主板带宽限制，需要换一个主板带宽大一点的板子

## 二、stf服务在云上（阿里云、腾讯云等），而手机在本地 

> 这种部署方式是那种没有较为稳定的本地服务器，且有外网访问需求的部署方式，这种本质上连接方式和上面提到的一致，但在启动命令上有所区别

- 常规stf启动方式

  - 执行`stf local --public-ip ******`
  - 这样会自动识别并连接插在运行stf服务器上的设备

- 分布式部署启动方式 

  - 因为设备不在云上，所以即便是启动了stf服务，也不能连接到手机

  - 第一步还是先启动服务`stf local --public-ip ******`

  - 第二步就需要一台本地机器连接设备了，同样还是开发者模式打开，执行下`adb devices`，如果有显示设备串号（并状态正常），就代表可以连接，我们接着执行`adb nodaemon server -a -P 5037`，如果没有出现异常我们就可以开始执行下一步了，但如果出现异常的话，我们需要杀掉adb服务，再来一次

  - 第三步需要我们在云上的那天服务器再执行一个stf的命令，用来监听连接设备的那台机器

    ```
    ./stf provider --name lins-MacBook-Pro.local --min-port 7400 --max-port 7700 --connect-sub tcp://127.0.0.1:7114 --connect-push tcp://127.0.0.1:7116 --group-timeout 900 --public-ip 192.168.13.180 --storage-url http://localhost:7100/ --adb-host 127.0.0.1 --adb-port 5037 --vnc-initial-size 600x800 --mute-master never --allow-remote
    ```

  - 需要修改的东西

    > 上面一整条命令都可以在最开始执行`stf local --public-ip ******`的输出里面找到，最方便的办法就是在启动命令里面找到这一条输出，复制下来，然后只需要修改`--adb-host`后面的IP为本地连接设备的那台机器IP，然后再执行这条命令

    - `lins-MacBook-Pro.local`：这个是我那台电脑的名字，这个名字可以在最开始执行`stf local --public-ip ******`的输出里面找到
    - `public-ip`：这个是云服务器的外网IP，也是启动命令中的那个IP
    - `--adb-host`：重要的是修改这个为连接设备的那台机器IP

## 三、多台机器连接到一台服务器

> 这种方式也叫做分布式部署，一台stf主服务，多台连接机，连接的方法和第二条一致，只不过是有几台就需要监听几台

🌰：我有一台运行stf服务的主服务器，此时已经启动好了，也能正常通过IP访问，我们假如主服务器的IP为192.168.8.8

那么主服务的启动命令就是`stf local --public-ip 192.168.8.8 --allow-remote`，访问就是http:192.168.8.8:7100

我们的几台连接机IP分别为：192.168.9.1、192.168.9.2、192.168.9.3

我们分别在连接机中暴露5037端口`adb nodaemon server -a -P 5037`

完成后，我们再去主服务器开三个窗口来分别执行，修改命令的方法和上面第二步一致，记得执行后不要关闭命令窗口

```
./stf provider --name lins-MacBook-Pro.local --min-port 7400 --max-port 7700 --connect-sub tcp://127.0.0.1:7114 --connect-push tcp://127.0.0.1:7116 --group-timeout 900 --public-ip 192.168.13.180 --storage-url http://localhost:7100/ --adb-host 127.0.0.1 --adb-port 5037 --vnc-initial-size 600x800 --mute-master never --allow-remote
```

至此，设备就能顺利连接上了